<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>game 1</title>
        <style media="screen">
            canvas {
                border: 1px black solid;
            }
        </style>
    </head>
    <body>
        <canvas id="id-canvas" width="400" height="300"></canvas>
        <hr>
        <!-- <input id=id-input-speed type="range" value="1"> -->

        <script>
        function  initCavas(){
            o = {
            } ;
            o.canvas = document.querySelector('#id-canvas') ;
            o.context = o.canvas.getContext('2d') ;
            return o ;
        }
        function loadImg(path){
            var img = new Image() ;
            img.src = path ;
            return img ;
        }



        var paddle = function(path){
            var o ={} ;
            o.x = 142 ;
            o.y = 245 ;
            o.speed = 15 ;
            o.img = loadImg(path) ;
            o.moveleft = function(){
                o.x -= o.speed ;
                if (o.x<0) {
                    o.x = 0 ;
                }
            } ;
            o.moveright = function(){
                o.x += o.speed ;
                if (o.x>336) {
                    o.x=336 ;
                }
            } ;
            return o ;
        }

        var ball = function (path){
            var o ={} ;
            o.x = 166 ;
            o.y = 238 ;
            o.img = loadImg(path) ;
            return o ;
        }





        var game = function (img,canvas){
            var g={
                actions: {},
                keydowns: {},
                canvas:canvas,
                img:img
            }

            // events
            window.addEventListener('keydown', function(event){
                g.keydowns[event.key] = true
            })
            window.addEventListener('keyup', function(event){
                g.keydowns[event.key] = false
            })
        

            g.registerAction = function(key, callback) {
                g.actions[key] = callback ;
                g.keydowns[key] = false ;
            }

            var runloop = function(){
                var actions = Object.keys(g.actions) ;
                for (var i = 0; i < actions.length; i++) {
                    var key = actions[i] ;
                    if(g.keydowns[key]) {
                        // 如果按键被按下, 调用注册的 action
                        g.actions[key]()
                    }
                }
                canvas.context.clearRect(0, 0, canvas.canvas.width, canvas.canvas.height)
                for(var i in g.img){
                    var img = g.img[i] ;
                    canvas.context.drawImage(img.img,img.x,img.y) ;
                }
                setTimeout(function(){
                    runloop() ;
                }, 1000/30) ;
            }
            g.start = function (){
                setTimeout(function(){
                runloop() ;
                }, 1000/30) ;
            }
            return g ;
        }

        var img = {} ;
        img.paddle = paddle('paddle.png') ;
        img.ball = ball('ball.png') ;
        var canvas = initCavas() ;
        var game = game(img,canvas) ;
        game.registerAction('a',function(){
            img.paddle.moveleft() ;
        }) ;
        game.registerAction('d',function(){
            img.paddle.moveright() ;  
        }) ;
        game.start() ;
        </script>
    </body>
</html>